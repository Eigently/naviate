#!/usr/bin/env bash

# Setup SSH keys
command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )
eval $(ssh-agent -s)

# The B64 private key can be generated by the following command: cat ~/.ssh/key_name | base64 -w0
echo $API_SERVER_SSH_PRIVATE_KEY_B64 | base64 -d | tr -d '\r' | ssh-add -
mkdir -p ~/.ssh
chmod 700 ~/.ssh
ssh-keyscan -t rsa $API_SERVER >> ~/.ssh/known_hosts

# Deploy docker image
rsync -Pavz d_atis.dockerimage root@$API_SERVER:~/
ssh root@$API_SERVER "cat d_atis.dockerimage | docker load; rm d_atis.dockerimage"
ssh root@$API_SERVER "dokku tags:create naviate-scds-d-atis-pubsub previous; dokku tags:deploy naviate-scds-d-atis-pubsub latest"
