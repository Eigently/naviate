build and push dockerized musl:
  image: docker:19.03.12
  stage: share
  needs:
    - build musl binary
  dependencies:
    - build musl binary
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "main"'
      changes:
        - server/**/*
        - .gitlab-ci.yml
      when: on_success
  artifacts:
    paths:
      - server/naviate.dockerimage
  tags:
    - docker
  services:
    - docker:19.03.12-dind
  before_script:
    - cd server
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE/alpine:$CI_COMMIT_SHORT_SHA --build-arg COMMIT_SHA=$CI_COMMIT_SHA .
    - docker push $CI_REGISTRY_IMAGE/alpine:$CI_COMMIT_SHORT_SHA
    - docker image tag $CI_REGISTRY_IMAGE/alpine:$CI_COMMIT_SHORT_SHA dokku/naviate-api:latest
    - docker save dokku/naviate-api:latest -o naviate.dockerimage

deploy dockerized musl:
  image: ubuntu:20.04
  stage: deploy
  needs:
    - build and push dockerized musl
  dependencies:
    - build and push dockerized musl
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - server/**/*
        - .gitlab-ci.yml
      when: on_success
  before_script:
    # Setup SSH keys
    - cd server
    - command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )
    - eval $(ssh-agent -s)
    # The B64 private key can be generated by the following command: cat ~/.ssh/key_name | base64 -w0
    - echo $API_SERVER_SSH_PRIVATE_KEY_B64 | base64 -d | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -t rsa $API_SERVER >> ~/.ssh/known_hosts
  script:
    - cat naviate.dockerimage | bzip2 | ssh root@$API_SERVER "bunzip2 | docker load"
    - ssh root@$API_SERVER "dokku tags:create naviate-api previous; dokku tags:deploy naviate-api latest"
